<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Grave Robber</title>
  <style>
    :root { --gap: 12px; --pad: 14px; --radius: 12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji; }
    body { margin: 0; background: #0b0d10; color: #e8eef7; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 22px; margin: 0 0 12px; letter-spacing: 0.2px; }
    .card { background: #12161c; border: 1px solid #1d2330; border-radius: var(--radius); padding: var(--pad); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
    @media (max-width: 820px) { .row, .row3 { grid-template-columns: 1fr; } }
    label { font-size: 13px; color: #b8c4d9; display: block; margin-bottom: 6px; }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%; background: #0c1118; border: 1px solid #212a3b; color: #e8eef7;
      border-radius: 10px; padding: 10px 12px; outline: none; box-sizing: border-box;
    }
    input[type="checkbox"] { transform: scale(1.2); }
    textarea { min-height: 140px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn {
      appearance: none; border: 0; border-radius: 10px; padding: 12px 14px;
      background: linear-gradient(180deg, #4a67ff, #3a55e6);
      color: white; font-weight: 600; cursor: pointer; transition: transform 0.02s ease-in-out, filter 0.15s;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: #22304a; }
    .actions { display: flex; gap: var(--gap); align-items: center; flex-wrap: wrap; }
    small, .sub { color: #98a7c2; }
    .pill { background: #0c1118; border: 1px solid #1e2a40; padding: 6px 10px; border-radius: 999px; font-size: 12px; color: #b8c4d9; }
    .muted { color: #7e8ba4; }
    .grid { display: grid; gap: var(--gap); }
    .video-frame { position: relative; width: 100%; padding-top: 56.25%; background: #0c1118; border-radius: 12px; overflow: hidden; border: 1px solid #1d2330; }
    .video-frame iframe { position: absolute; inset: 0; width: 100%; height: 100%; }
    .meta { display: grid; gap: 6px; }
    .meta-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    code.inline { background: #0c1118; padding: 2px 6px; border-radius: 6px; border: 1px solid #1e2a40; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #101521; border: 1px solid #22304a; border-bottom-width: 3px; padding: 2px 6px; border-radius: 6px; }
    .alert { background: #2c1b1b; border: 1px solid #6b2b2b; padding: 12px; border-radius: 10px; color: #ffd2d2; }
    .ok { background: #13261a; border: 1px solid #295a38; padding: 12px; border-radius: 10px; color: #c8f1d1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="wrap grid">
    <h1>YouTube Grave Robber</h1>

    <div class="card grid">
      <div class="row">
        <div class="row3">
          <div>
            <label for="maxViews">Max views</label>
            <input id="maxViews" type="number" min="0" step="1" value="2000" />
          </div>
          <div>
            <label for="yearMin">Min year</label>
            <input id="yearMin" type="number" min="2006" max="2030" value="2006" />
          </div>
          <div>
            <label for="yearMax">Max year</label>
            <input id="yearMax" type="number" min="2006" max="2030" value="2025" />
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="templates">Filename templates (one per line)</label>
          <textarea id="templates"></textarea>
          <small class="muted">Tokens: <code class="inline">YYYY</code>, <code class="inline">MM</code>, <code class="inline">DD</code>, <code class="inline">####</code>, <code class="inline">######</code>.</small>
        </div>
        <div>
          <label>Diagnostics</label>
          <div id="diag" class="alert mono">Waiting…</div>
        </div>
      </div>

      <div class="actions">
        <button id="save" class="btn secondary">Save Settings</button>
        <button id="next" class="btn">Next ▶</button>
        <button id="skip" class="btn secondary">Skip ↻</button>
        <span id="status" class="sub"></span>
      </div>
    </div>

    <div class="card grid">
      <div class="video-frame" id="playerWrap">
        <iframe id="player" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>
      <div class="meta">
        <div class="meta-row"><span id="title" class="sub"></span></div>
        <div class="meta-row">
          <span class="pill" id="pillQuery"></span>
          <span class="pill" id="pillViews"></span>
          <span class="pill" id="pillChannel"></span>
        </div>
        <div class="meta-row">
          <a id="openInYT" href="#" target="_blank" rel="noopener noreferrer">Open on YouTube ↗</a>
        </div>
      </div>
    </div>

    <div class="card grid">
      <strong>System-title detector (loose)</strong>
      <small class="muted">We still show the pick even if the title does not match, but this can help tune your templates.</small>
      <code id="detector" style="white-space: pre-wrap;"></code>
    </div>
  </div>

  <script>
    const els = {
      maxViews: document.getElementById("maxViews"),
      yearMin: document.getElementById("yearMin"),
      yearMax: document.getElementById("yearMax"),
      templates: document.getElementById("templates"),
      save: document.getElementById("save"),
      test: document.getElementById("test"),
      next: document.getElementById("next"),
      skip: document.getElementById("skip"),
      player: document.getElementById("player"),
      title: document.getElementById("title"),
      pillQuery: document.getElementById("pillQuery"),
      pillViews: document.getElementById("pillViews"),
      pillChannel: document.getElementById("pillChannel"),
      openInYT: document.getElementById("openInYT"),
      status: document.getElementById("status"),
      detector: document.getElementById("detector"),
      diag: document.getElementById("diag")
    };

    const DEFAULT_TEMPLATES = [
      "IMG_YYYYMMDD_####",
      "PXL_YYYYMMDD_######",
      "VID_YYYYMMDD_####",
      "VID-YYYYMMDD-WA####",
      "IMG-YYYYMMDD-WA####",
      "IMG E####",
      "MOV ####",
      "MVI_####",
      "DSC_####",
      "CIMG####",
      "GH01####",
      "GX01####",
      "DJI_####",
      "Screen Recording ####",
      "RPReplay_Final####"
    ].join("\\n");

    const SYS_TITLE_REGEX = /^(IMG(?:[-_E])?|PXL|VID|MOV|MVI|DSC|CIMG|GH0\d|GX0\d|DJI|RPReplay|Screen Recording)[\-_ \s]?[0-9A-Za-z_\- ]{3,}$/;

    function setDiag(msg, ok = false) {
      els.diag.textContent = msg;
      els.diag.className = ok ? "ok mono" : "alert mono";
    }

    function loadSettings() {
      els.maxViews.value = localStorage.getItem("bingoviews") || "2000";
      els.yearMin.value = localStorage.getItem("bingoymin") || "2006";
      els.yearMax.value = localStorage.getItem("bingoymax") || "2025";
      els.templates.value = localStorage.getItem("bingotemplates") || DEFAULT_TEMPLATES;

      if (location.protocol === "file:") {
        setDiag("Warning: Opened via file://. Use a local server like `python -m http.server 5500` and open http://localhost:5500/… so API referrer restrictions work.");
      } else {
        setDiag("Ready.", true);
      }
    }

    function saveSettings() {
      localStorage.setItem("bingoviews", els.maxViews.value.trim());
      localStorage.setItem("bingoymin", els.yearMin.value.trim());
      localStorage.setItem("bingoymax", els.yearMax.value.trim());
      localStorage.setItem("bingotemplates", els.templates.value);
      toast("Saved settings.");
    }

    function toast(msg) {
      els.status.textContent = msg;
      setTimeout(() => { els.status.textContent = ""; }, 2200);
    }

    function randInt(min, maxInclusive) {
      return Math.floor(Math.random() * (maxInclusive - min + 1)) + min;
    }
    function pad2(n) { return String(n).padStart(2, "0"); }
    function digits(len) { let out = ""; for (let i = 0; i < len; i++) out += randInt(0, 9); return out; }
    function pickTemplate() {
      const lines = els.templates.value.split(/\\r?\\n/).map(s => s.trim()).filter(Boolean);
      if (lines.length === 0) return "IMG_YYYYMMDD_####";
      return lines[randInt(0, lines.length - 1)];
    }
    function generateFromTemplate(tpl) {
      const y0 = parseInt(els.yearMin.value, 10) || 2014;
      const y1 = parseInt(els.yearMax.value, 10) || 2025;
      const year = randInt(Math.min(y0, y1), Math.max(y0, y1));
      const month = pad2(randInt(1, 12));
      const day = pad2(randInt(1, 28));
      let out = tpl;
      out = out.replaceAll("YYYY", String(year));
      out = out.replaceAll("MM", String(month));
      out = out.replaceAll("DD", String(day));
      out = out.replaceAll("######", digits(6));
      out = out.replaceAll("####", digits(4));
      return out;
    }
    function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

    async function ytSearchRandomPick(query, maxViews) {
      const searchUrl = new URL("https://no0pns7n07.execute-api.us-east-1.amazonaws.com/default/yt/search");
      searchUrl.searchParams.set("part", "snippet");
      searchUrl.searchParams.set("maxResults", "50");
      searchUrl.searchParams.set("q", "\"" + query + "\"");
      searchUrl.searchParams.set("type", "video");
      searchUrl.searchParams.set("videoEmbeddable", "true");
      searchUrl.searchParams.set("safeSearch", "none");
      const orders = ["relevance", "date", "rating", "viewCount"];
      searchUrl.searchParams.set("order", orders[randInt(0, orders.length - 1)]);

      const res = await fetch(searchUrl.toString());
      if (!res.ok) {
        const text = await res.text();
        throw new Error("Search failed " + res.status + ": " + text);
      }
      const data = await res.json();
      const items = data.items || [];
      const ids = items.map(it => it.id && it.id.videoId).filter(Boolean);
      if (ids.length === 0) return null;

      const vidsUrl = new URL("https://no0pns7n07.execute-api.us-east-1.amazonaws.com/default/yt/videos");
      vidsUrl.searchParams.set("part", "snippet,statistics");
      vidsUrl.searchParams.set("id", ids.join(","));
      const vres = await fetch(vidsUrl.toString());
      if (!vres.ok) {
        const text = await vres.text();
        throw new Error("Videos failed " + vres.status + ": " + text);
      }
      const vdata = await vres.json();
      let vitems = vdata.items || [];

      vitems = vitems.filter(v => {
        const vc = parseInt((v.statistics && v.statistics.viewCount) || "0", 10);
        return isFinite(vc) && vc <= maxViews;
      });

      const sys = vitems.filter(v => SYS_TITLE_REGEX.test((v.snippet && v.snippet.title) || ""));
      const pool = sys.length > 0 ? sys : vitems;
      if (pool.length === 0) return null;
      shuffle(pool);
      return pool[0];
    }

    async function nextPick(retryBudget = 5) {
      const maxViews = parseInt(els.maxViews.value, 10) || 2000;

      els.pillQuery.textContent = "…";
      els.pillViews.textContent = "";
      els.pillChannel.textContent = "";
      els.title.textContent = "";
      els.openInYT.href = "#";
      els.player.src = "";
      els.detector.textContent = "";

      let attempt = 0;
      while (attempt < retryBudget) {
        attempt++;
        const tpl = pickTemplate();
        const query = generateFromTemplate(tpl);
        els.pillQuery.textContent = query;
        setDiag("Searching for " + query + " (attempt " + attempt + "/" + retryBudget + ")…", true);

        try {
          const pick = await ytSearchRandomPick(query, maxViews);
          if (pick) {
            const vidId = pick.id;
            const title = pick.snippet.title;
            const views = parseInt((pick.statistics && pick.statistics.viewCount) || "0", 10);
            const chan = pick.snippet.channelTitle;
            const url = "https://www.youtube.com/watch?v=" + vidId;

            els.player.src = "https://www.youtube.com/embed/" + vidId + "?autoplay=1&rel=0";
            els.title.textContent = title;
            els.pillViews.textContent = new Intl.NumberFormat().format(views) + " views";
            els.pillChannel.textContent = "by " + chan;
            els.openInYT.href = url;

            const regOk = SYS_TITLE_REGEX.test(title);
            els.detector.textContent = "Title: " + title + "\\nMatches system-title regex: " + (regOk ? "Yes" : "No") + "\\nTemplate used: " + tpl;
            setDiag("Found one: " + title, true);
            toast("Found one!");
            return;
          } else {
            setDiag("No low-view results for " + query + ". Trying another…", false);
          }
        } catch (err) {
          console.error(err);
          setDiag("API error: " + err.message, false);
          toast("API error; see Diagnostics.");
          return;
        }
        await new Promise(r => setTimeout(r, 200));
      }
      setDiag("Out of attempts. Widen the year range or increase Max views.", false);
      toast("Try widening years or increasing Max views.");
    }

    // Events
    els.save.addEventListener("click", saveSettings);
    els.next.addEventListener("click", () => nextPick());
    els.skip.addEventListener("click", () => nextPick());
    document.addEventListener("keydown", e => { if (e.key === "Enter") { nextPick(); } });

    // Init
    loadSettings();
  </script>
</body>
</html>